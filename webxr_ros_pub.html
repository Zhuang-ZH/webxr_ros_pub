<!doctype html>
<html>

<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.js"></script>
  <title>WebXR Pose to ROS</title>
</head>

<body>
  <header>
    <details open>
      <summary>WebXR Pose to ROS</summary>
      <p>Publish WebXR Viewer & Controller Poses to ROS</p>
      <form id="rosbridge_settings_form" action="javascript:void(0);">
        <label for="websocket_url">WebSocket URL:</label>
        <input type="text" id="websocket_url" value="wss://127.168.31.130:9090">
        <input type="submit" value="Connect">
      </form>
      <div id="pose_viewer"></div>
      <div id="pose_left_hand"></div>
      <div id="pose_right_hand"></div>
      <div id="debug-info"></div>
      <button id="xr-button" disabled>XR not found</button>
    </details>
  </header>

  <script type="module">
    var ros = null;
    var poseViewerTopic = null;
    var leftHandTopic = null;
    var rightHandTopic = null;

    document.getElementById("rosbridge_settings_form").onsubmit = function () {
      ros = new ROSLIB.Ros({ url: this.elements.websocket_url.value });

      leftHandTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/left_hand_pose',
        messageType: 'geometry_msgs/PoseStamped'
      });

      rightHandTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/right_hand_pose',
        messageType: 'geometry_msgs/PoseStamped'
      });

      poseViewerTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/pose',
        messageType: 'geometry_msgs/PoseStamped'
      });
    };

    let xrButton = document.getElementById('xr-button');
    let xrSession = null;
    let xrRefSpace = null;

    function initXR() {
      if (navigator.xr) {
        xrButton.addEventListener('click', onButtonClicked);
        navigator.xr.isSessionSupported('immersive-ar').then(supported => {
          xrButton.innerHTML = supported ? 'Enter AR' : 'AR not found';
          xrButton.disabled = !supported;
        });
      }
    }

    function onButtonClicked() {
      if (!xrSession) {
        navigator.xr.requestSession('immersive-ar', { optionalFeatures: ['dom-overlay'] }).then(onSessionStarted);
      } else {
        xrSession.end();
      }
    }

    function onSessionStarted(session) {
      xrSession = session;
      xrButton.innerHTML = 'Exit AR';
      session.requestReferenceSpace('local').then(refSpace => {
        xrRefSpace = refSpace;
        session.requestAnimationFrame(onXRFrame);
      });
    }

    function onXRFrame(t, frame) {
      let session = frame.session;
      session.requestAnimationFrame(onXRFrame);
      
      let debugText = "WebXR Debug Info:\n";
      debugText += `XR Input Sources: ${session.inputSources.length}\n`;
      let pose = frame.getViewerPose(xrRefSpace);
      if (pose) publishPose(pose, 'world', poseViewerTopic, 'pose_viewer');

      for (let source of session.inputSources) {
        if (source.gripSpace) {
          let controllerPose = frame.getPose(source.gripSpace, xrRefSpace);
          if (controllerPose) {
            let frame_id = source.handedness === 'left' ? 'left_controller' : 'right_controller';
            let topic = source.handedness === 'left' ? leftHandTopic : rightHandTopic;
            let displayId = source.handedness === 'left' ? 'pose_left_hand' : 'pose_right_hand';
            publishPose(controllerPose, frame_id, topic, displayId);
            debugText += `${frame_id} Pose Published\n`;
          }
        } else {
          debugText += "No gripSpace available for an input source.\n";
        }
      }
      document.getElementById("debug-info").innerText = debugText;
    }

    function publishPose(pose, frame_id, topic, displayId) {
      const p = pose.transform.position;
      const o = pose.transform.orientation;

      let message = new ROSLIB.Message({
        header: { frame_id: frame_id },
        pose: {
          position: { x: -p.z, y: -p.x, z: p.y },
          orientation: { x: o.x, y: o.y, z: o.z, w: o.w }
        }
      });
      topic.publish(message);

      document.getElementById(displayId).innerText = frame_id + " Pose: " + 
        `Position(${p.x.toFixed(3)}, ${p.y.toFixed(3)}, ${p.z.toFixed(3)})\n` +
        `Orientation(${o.x.toFixed(3)}, ${o.y.toFixed(3)}, ${o.z.toFixed(3)}, ${o.w.toFixed(3)})`;
    }

    initXR();
  </script>
</body>
</html>
